<!doctype html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Dust My Groom</title>
  <link rel="stylesheet" href="app.css">
  <link rel="stylesheet" href="style.css">
  <link rel="stylesheet" href="modal.css">
</head>

<body>
  <div id="groom"></div>
  <script src="bundle.js"></script>
  <script src="https://www.gstatic.com/firebasejs/3.4.1/firebase.js"></script>
  <script>
    function guid() {
        function s4() {
          return Math.floor((1 + Math.random()) * 0x10000)
            .toString(16)
            .substring(1);
        }
        return s4() + s4() + '-' + s4() + '-' + s4() + '-' +
          s4() + '-' + s4() + s4() + s4();
    }

    var userName = ''
    var userId = ''
    if(localStorage) {
        userName = localStorage.getItem('userName') || ''
        userId = localStorage.getItem('userId') || ''
    }


    // Initialize Firebase
    var config = {
      apiKey: "AIzaSyBty8SUQvWPywPS4lwyZSs_9JsQMoMksHM",
      authDomain: "dust-my-groom.firebaseapp.com",
      databaseURL: "https://dust-my-groom-test.firebaseio.com",
      storageBucket: "dust-my-groom.appspot.com",
      messagingSenderId: "105795449472"
    };
    firebase.initializeApp(config);
    var database = firebase.database();

    var app = Elm.MainWithLayout.embed(document.getElementById("groom"), {
      uuid: guid(),
      userName: userName,
      userId: userId
    })

    app.ports.saveUser.subscribe(function(user) {
      if(localStorage) {
        localStorage.setItem('userName', user.name)
        localStorage.setItem('userId', user.id)
      }
    })

    var teamConnection = null

    app.ports.loadTeam.subscribe(function(teamId) {
      // console.log('attempt to loadTeam', teamId)

      if(teamConnection) {
        teamConnection.unsubscribe()
        teamConnection = null;
      }
      app.ports.teamUnloaded.send('')
      // console.log('prev team unloaded')

      var teamNameRef = database.ref().child(teamId).child('name')

      teamNameRef.once('value', function(name) {
        var teamName = name.val()
        // console.log('loadedTeam', teamName)

        if(teamName) {
          // TODO send team object wiht name
          teamConnection = connectToTeam(teamId)
          app.ports.teamLoaded.send(teamId)
        }

      })
    })




    function connectToTeam(teamID) {

      console.log('SUBSCRIBE', teamID)

      var currentStoryRef = database.ref().child(teamID).child('currentStory')
      var votesRef = database.ref().child(teamID).child('votes')
      var historyRef = database.ref().child(teamID).child('history')


      // current story
      currentStoryRef.on('value', function(currentStory) {
        var story = currentStory.val();
        if(story) {
          app.ports.storySizingStarted.send(story)
        } else {
          app.ports.storySizingEnded.send("")
        }
      })

      function startStorySizing(story) {
        currentStoryRef.set(story);
      }

      app.ports.startStorySizing.subscribe(startStorySizing)

      function cancelStory(story) {
        votesRef.set(null)
        currentStoryRef.set(null)
      }

      app.ports.cancelStory.subscribe(cancelStory)


      // votes
      votesRef.on('child_added', function(vote) {
        app.ports.voteAdded.send(vote.val())
      })

      votesRef.on('value', function(votes) {
        if( votes.val() === null){
          app.ports.votesCleared.send("")
        }
      })

      function addVote(vote) {
        votesRef.push(vote)
      }

      app.ports.addVote.subscribe(addVote)

      function resizeStory(story) {
        votesRef.set(null)
      }

      app.ports.resizeStory.subscribe(resizeStory)


      // history
      historyRef.on('child_added', function(story) {
        app.ports.storyArchived.send(story.val())
      })

      function archiveStory(story) {
        historyRef.push(story)
        votesRef.set(null)
        currentStoryRef.set(null);
      }

      app.ports.archiveStory.subscribe(archiveStory)

      return {
        id: teamID,
        unsubscribe: function unsubscribe() {
          console.log('UNSUBSCRIBE', teamID)

          currentStoryRef.off('value')
          votesRef.off('child_added')
          votesRef.off('value')
          historyRef.off('child_added')
          app.ports.startStorySizing.unsubscribe(startStorySizing)
          app.ports.cancelStory.unsubscribe(cancelStory)
          app.ports.addVote.unsubscribe(addVote)
          app.ports.resizeStory.unsubscribe(resizeStory)
          app.ports.archiveStory.unsubscribe(archiveStory)
        }
      }

    }

    // migration
    function copyFbRecord(oldRef, newRef) {
      oldRef.once('value', function(snap)  {
        newRef.set( snap.val(), function(error) {
          if( error && typeof(console) !== 'undefined' && console.error ) {  console.error(error); }
        });
      });
    }

    // copyFbRecord(database.ref().child('history'), historyRef)

  </script>
</body>

</html>
