<!doctype html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Dust My Groom</title>
  <link rel="stylesheet" href="app.css">
  <link rel="stylesheet" href="modal.css">
</head>

<body>
  <div id="groom"></div>
  <script src="bundle.js"></script>
  <script src="https://www.gstatic.com/firebasejs/3.4.1/firebase.js"></script>
  <script>
  function guid() {
      function s4() {
        return Math.floor((1 + Math.random()) * 0x10000)
          .toString(16)
          .substring(1);
      }
      return s4() + s4() + '-' + s4() + '-' + s4() + '-' +
        s4() + '-' + s4() + s4() + s4();
  }

  var userName = ''
  var userId = ''
  if(localStorage) {
      userName = localStorage.getItem('userName') || ''
      userId = localStorage.getItem('userId') || ''
  }

  var app = Elm.MainWithLayout.embed(document.getElementById("groom"), {
      uuid: guid(),
      userName: userName,
      userId: userId
  })
    // Initialize Firebase
    var config = {
      apiKey: "AIzaSyBty8SUQvWPywPS4lwyZSs_9JsQMoMksHM",
      authDomain: "dust-my-groom.firebaseapp.com",
      databaseURL: "https://dust-my-groom-test.firebaseio.com",
      storageBucket: "dust-my-groom.appspot.com",
      messagingSenderId: "105795449472"
    };
    firebase.initializeApp(config);
    var database = firebase.database();

    app.ports.saveUser.subscribe(function(user) {
        if(localStorage) {
            localStorage.setItem('userName', user.name)
            localStorage.setItem('userId', user.id)
        }
    })

    // current story
    var currentStoryRef = database.ref().child('currentStory')
    app.ports.startStorySizing.subscribe(function(story) {
      canselStory()
      currentStoryRef.set(story);
      votesRevelaedRef.set(false);
    })

    currentStoryRef.on('value', function(currentStory) {
      var story = currentStory.val();
      if(story) {
        app.ports.storySizingStarted.send(story)
      } else {
        app.ports.storySizingEnded.send("")
      }
    })

    // votes
    var votesRef = database.ref().child('votes')
    app.ports.addVote.subscribe(function(vote) {
      votesRef.push(vote)
    })

    votesRef.on('child_added', function(vote) {
      app.ports.voteAdded.send(vote.val())
    })

    votesRef.on('value', function(votes) {
      if( votes.val() === null){
          app.ports.votesCleared.send("")
      }
    })

    // votesRef.on('value', function(votes) {
    //   console.log("votes changed", votes.val())
    //   if(votes.val() === null){
    //     // TODO set model.votes to []
    //   }
    // })


    // reveal votes
    var votesRevelaedRef = database.ref().child('votesRevelaed')
    app.ports.revealVotes.subscribe(function(flag) {
      votesRevelaedRef.set(flag);
    })

    votesRevelaedRef.on('value', function(votesRevelaed) {
        var flag = votesRevelaed.val() || false
        app.ports.votesRevealed.send(flag)
    })

    // history
    var historyRef = database.ref().child('history')
    app.ports.archiveStory.subscribe(function(story) {
      historyRef.push(story)
      votesRef.set(null)
      currentStoryRef.set(null);
    })

    historyRef.on('child_added', function(story) {
      app.ports.storyArchived.send(story.val())
    })


    app.ports.cancelStory.subscribe(function(story) {
        canselStory()
    })

    app.ports.resizeStory.subscribe(function(story) {
        votesRef.set(null)
    })

    function canselStory() {
      votesRef.set(null)
      currentStoryRef.set(null)
    }

  </script>
</body>

</html>
